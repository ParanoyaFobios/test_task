{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h2>Управление парсером Amazon</h2>
    
    <div class="card mt-3">
        <div class="card-body">
            <h5 class="card-title">Запуск парсера</h5>
            <p class="card-text">Введите параметры для поиска:</p>
            
            <div class="form-group mb-3">
                <label for="categoryInput">Категория для поиска:</label>
                <input type="text" class="form-control" id="categoryInput" 
                       placeholder="Например: laptops, kitchen and dining" value="laptops">
            </div>
            
            <div class="form-group mb-3">
                <label for="pagesSelect">Количество страниц (1-5):</label>
                <select class="form-control" id="pagesSelect">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                </select>
            </div>
            
            <button id="runScraperBtn" class="btn btn-primary">
                <span id="spinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                Запустить парсер
            </button>
            
            <div id="statusMessage" class="mt-3 alert" style="display: none;"></div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('runScraperBtn');
    const spinner = document.getElementById('spinner');
    const statusMsg = document.getElementById('statusMessage');
    const categoryInput = document.getElementById('categoryInput');
    const pagesSelect = document.getElementById('pagesSelect');
    
    btn.addEventListener('click', async function() {
        const category = categoryInput.value.trim();
        const pages = pagesSelect.value;
        
        if (!category) {
            statusMsg.textContent = 'Пожалуйста, введите категорию для поиска';
            statusMsg.className = 'mt-3 alert alert-warning';
            statusMsg.style.display = 'block';
            return;
        }
        
        btn.disabled = true;
        spinner.classList.remove('d-none');
        statusMsg.style.display = 'none';
        
        try {
            const response = await fetch('{% url "run_scraper" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    category: category,
                    pages: pages
                })
            });
            
            const data = await response.json();
            
            if (data.status) {
                statusMsg.textContent = data.status;
                statusMsg.className = 'mt-3 alert alert-success';
            } else if (data.error) {
                statusMsg.textContent = 'Ошибка: ' + data.error;
                statusMsg.className = 'mt-3 alert alert-danger';
            }
            
        } catch (error) {
            statusMsg.textContent = 'Ошибка сети: ' + error;
            statusMsg.className = 'mt-3 alert alert-danger';
        } finally {
            statusMsg.style.display = 'block';
            spinner.classList.add('d-none');
            setTimeout(() => {
                btn.disabled = false;
            }, 10000); // Блокировка кнопки на 10 секунд
        }
    });
});
</script>
{% endblock %}